<!doctype html>
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>	   <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>	   <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="version" content="4.0">
<meta name="author" content="Puneet Kishor">
<meta name="copyright" content="CC0 Public Domain Dedication">
<meta http-equiv="Cache-Control" content="max-age=604800, public">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>punkish: expressjs app with socket.io</title>

<!-- see https://stackoverflow.com/questions/1321878/how-to-prevent-favicon-ico-requests -->
<link rel="icon" href="data:;base64,iVBORw0KGgo=">

<!-- <link rel="stylesheet" href="/_lib/css/fonts.css"> -->
<link rel="stylesheet" href="/_lib/css/styles.css">
<link rel="stylesheet" href="/_lib/JavaScript-autoComplete/auto-complete.css">


<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.0.1/styles/default.min.css">




</head>
<body>
    <header class="row"><div>
    <a href="/" class="home">

        <img src="/_lib/img/PunkishEidesisOrg.gif">
    </a> 

    <form name="search" method="GET" action="">
        <input name="q" type="text" placeholder="there are none so blind as those who don’t see">
    </form>
</div>
<nav>
    <a href="/cv-latest/">cv</a>
    <a href="/Where/">where</a>
    <a href="/_dates/">dates</a>
    <a href="/_tags/">tags</a>
</nav></header>
    
    <main><section>
    <h1 class="title">expressjs app with socket.io</h1>
    <div class="description"></div>
    <div class="created">Tuesday, October 11, 2016</div>
    
    <div class="content"><p>I have the following app structure generated by <code>express generator</code>. I start the app with <code>$ DEBUG=foo:* npm start</code></p>
<pre><code class="hljs language-hljs">.
|____app.js
|____bin
| |____www
|____data
| |____readings.db
|____LICENSE
|____node_modules
| |____express
| |____ …
|____package.json
|____public
| |____stylesheets
| |____javascripts
| |____images
|____README.md
|____routes
| |____index.js
| |____readings.js
| |____sensors.js
|____views
| |____error.hjs
| |____index.hjs
</code></pre>
<p>In <code>app.js</code></p>
<pre><code>var express = require('express');
var app = express();
var io = require('socket.io')();
app.io = io;

// notice the `(io)` for the routes that need to be socket-aware
var routes = require('./routes/index');
var sensors = require('./routes/sensors');
var readings = require('./routes/readings')(io);

…

// start listening with socket.io
app.io.on('connection', function(socket){  
    console.log('a user connected');
});

module.exports = app;
</code></pre>
<p>In <code>./bin/www</code></p>
<pre><code class="js language-js">app.io.attach(server);
</code></pre>
<p>Then in <code>./routes/readings.js</code> that should be socket-aware</p>
<pre><code class="js language-js">var express = require('express');
var app = express();
var router = express.Router();
var path = require('path');
var Datastore = require('nedb');
var db_readings = new Datastore({
    filename: path.join(__dirname. '..' , 'data' , 'readings.db'), 
    autoload: true
});

module.exports = function(io) {
    router.put('/', jsonParser, function(req, res, next) {
        if (!req.body) return res.sendStatus(400);

        db_readings.insert(req.body, function (err, newDoc) {
            io.emit("reading", {id: newDoc._id});
            res.send('Success PUTting data! id: ' + newDoc._id);
        });
    });

    return router;
}
</code></pre>
<p>Finally, in the <code>index.hjs</code> template for the client-side</p>
<pre><code class="html language-html">&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
&lt;script&gt;
    var socket = io();
    socket.on('reading', function (data) {
        console.log(data);
    });
&lt;/script&gt;
</code></pre>
<p>The above works. When data are inserted into <code>readings.db</code> via an http <code>PUT</code> (see <code>readings.js</code>), an event is emitted by <code>io.emit('reading', data)</code> and the browser receives that event and shows it in the browser console with <code>socket.on('reading', function (data) { … });</code></p></div>

    <ul class="tags">
        <li><a href="/_tags/code.html">code</a></li>
        <li><a href="/_tags/programming.html">programming</a></li>
        <li><a href="/_tags/javascript.html">javascript</a></li>
        <li><a href="/_tags/nodejs.html">nodejs</a></li>
    </ul>
    <ul class="bottomNav">
        <li class="prev"><a href="/Geottingen">↜ Geottingen</a></li>
        <li class="next"><a href="/As-We-May-Click">As We May Click ⇝</a></li>
    </ul></section></main>

    <footer><p>Dedicated to the public domain under the <a href="https://creativecommons.org/publicdomain/zero/1.0/legalcode" target="_blank">CC0 Public Domain Dedication</a></p></footer>

    <script src="https://cdn.jsdelivr.net/npm/minisearch@3.0.4/dist/umd/index.min.js"></script>
    <script src="/_lib/JavaScript-autoComplete/auto-complete.js"></script>
    <script src="/_lib/js/polyfill.js"></script>
    <script src="/_lib/js/punkish.js"></script>
    
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.0.1/highlight.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.1.6/highlightjs-highlight-lines.min.js"></script>
    <script>
        hljs.initHighlighting()
    </script>
    
    
    
    
    
    
    <script>
        fetch("/_search/searchIdx.json")
            .then(response => response.text())
            .then(text => {
                window.miniSearch = MiniSearch.loadJSON(text, {
                    fields: ['title', 'text'],
                    storeFields: ['title', 'name'],
                    searchOptions: {
                        boost: { title: 2 },
                        fuzzy: 0.2
                    }
                })
            })
            .catch(err => console.log(err))
    
        window.onload = function() {
            PK.autocomplete();
            PK.initializeDictionary();
    
            const searchInPage = document.getElementById('searchInPage')
            if (searchInPage) {
                const inp = document.getElementsByName('tag')
                inp[0].addEventListener('keyup', PK.searchInPage)
            }
        }()
    </script></body>
</html>